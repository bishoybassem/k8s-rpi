- name: Copy kubectl binary
  copy: 
    src: downloads/kubectl
    dest: /usr/bin
    mode: 0755

- name: Create home directory for kubectl
  file:
    path: /root/.kube
    state: directory

- name: Copy kubeconfig
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 0644
  with_items:
    - { src: kubeconfig.yml, dest: /etc/kubernetes/kubelet/kubeconfig.yml }
    - { src: kubeconfig.yml, dest: /etc/kubernetes/kube-proxy/kubeconfig.yml }
    - { src: kubeconfig.yml, dest: /root/.kube/config }

- name: Create apiserver and controller-manager directories
  file:
    path: "/etc/kubernetes/{{ item }}"
    state: directory
  with_items:
    - apiserver
    - controller-manager

- name: Copy config file for generating csr
  template:
    src: csr.conf.j2
    dest: /etc/kubernetes/apiserver/csr.conf
    mode: 0644

- name: Generate tls key and certificate
  shell: |
    openssl genrsa -out tls.key
    openssl req -new -key tls.key -out tls.csr -config csr.conf
    openssl x509 -req -in tls.csr -CA /etc/ssl/certs/ca.crt -CAkey /etc/ssl/private/ca.key -CAcreateserial -out tls.crt -days 10000 -extensions v3_ext -extfile csr.conf
  args:
    chdir: /etc/kubernetes/apiserver
    creates: tls.crt

- name: Generate rsa private key for service accounts
  shell: openssl genrsa -out /etc/kubernetes/controller-manager/sa-private.pem
  args:
    creates: /etc/kubernetes/controller-manager/sa-private.pem

- name: Generate rsa public key for service accounts
  shell: openssl rsa -in controller-manager/sa-private.pem -outform PEM -pubout -out apiserver/sa-public.pem
  args:
    chdir: /etc/kubernetes
    creates: apiserver/sa-public.pem

- name: Copy pods and tokens
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  with_items:
    - { src: known-tokens.csv.j2, dest: /etc/kubernetes/apiserver/known-tokens.csv, mode: "600" }
    - { src: kube-apiserver.yml.j2, dest: /etc/kubernetes/manifests/kube-apiserver.yml, mode: "644" }
    - { src: kube-controller-manager.yml.j2, dest: /etc/kubernetes/manifests/kube-controller-manager.yml, mode: "644" }
    - { src: kube-scheduler.yml.j2, dest: /etc/kubernetes/manifests/kube-scheduler.yml, mode: "644" }

- name: Create directory for pods
  file:
    path: /etc/kubernetes/pods
    state: directory
    mode: 0666